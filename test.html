<!doctype html>
<html>
  <head>
    <title>YOLO Live Feed</title>
  </head>

  <body>
    <video id="webcam" autoplay playsinline style="display: none"></video>
    <canvas id="output"></canvas>

    <script>
      const video = document.getElementById('webcam')
      const canvas = document.getElementById('output')
      const ctx = canvas.getContext('2d')

      let ws

      async function startWebcam() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 },
        })
        video.srcObject = stream

        // Connect to WebSocket
        ws = new WebSocket('ws://localhost:4000/ws/predict')

        ws.onopen = () => {
          console.log('WebSocket connected')
          sendFrame()
        }

        ws.onmessage = event => {
          const data = JSON.parse(event.data)

          try {
            const img = new Image()
            img.onload = () => {
              canvas.width = img.width
              canvas.height = img.height
              ctx.drawImage(img, 0, 0)
            }
            if (data.i) {
              img.src = data.i
            }

            // Process detections if needed
            console.log('Detections:', data.d)
          } catch {
            //
          }

          // Send next frame
          setTimeout(sendFrame, 100) // ~10 FPS
        }
      }

      function sendFrame() {
        if (ws.readyState === WebSocket.OPEN) {
          canvas.width = video.videoWidth
          canvas.height = video.videoHeight
          ctx.drawImage(video, 0, 0)

          const imageData = canvas.toDataURL('image/jpeg', 1.0)
          ws.send(imageData)
        }
      }

      startWebcam()
    </script>
  </body>
</html>
